(function(){App.Ui.EditStoryDialog=Core.make();var c=Core.Ui.Mobile.isMobile();App.Ui.EditStoryDialog.prototype={editStory:null,init:function(b,a){this.ucsId=a;this.requestUri=b;var e={requestUri:this.requestUri,requestData:{ucs_code:a,reviewMode:!0},skin:c?"rtk-mobl-dlg":"rtk-skin-dlg",mobile:c,close:!c,width:500,scope:this,events:{onDialogResponse:this.onDialogResponse,onDialogDestroy:this.onDialogDestroy,onDialogHide:this.onDialogHide}};c||(e.context=["uiFcMain","tl","tl",null,[-10,-36]]);this.dialog=
new Core.Ui.AjaxDialog(null,e);this.dialog.show();c&&this.addCloseButton()},addCloseButton:function(){var b=document.createElement("div");b.innerHTML='<div class="uiBMenu"><div class="uiBMenuItem"><a class="uiFcBtnGreen JSDialogHide uiIBtn uiIBtnDefault" href="#"><span>Close</span></a></div></div>';this.dialog.getBody().appendChild(b)},load:function(b){this.ucsId!==b&&(this.onDialogDestroy(),this.dialog.setBodyLoading(500),c&&this.addCloseButton(),this.ucsId=b,this.dialog.getAjaxPanel().get({ucs_code:b,
reviewMode:!0},this.requestUri))},show:function(){this.dialog.show()},hide:function(){this.dialog.hide()},onDialogHide:function(){return!1},onDialogResponse:function(b){b=b.getProps();b={kanjiData:b.kanjiData,custKeyword:b.custKeyword,isReviewMode:!0,isFavoriteStory:b.isFavoriteStory,postStoryEdit:b.postStoryEdit,postStoryView:b.postStoryView,postStoryPublic:b.postStoryPublic};var a=this.dialog.getBody().querySelector("div");this.editStory=Koohii.Refs.vueEditStory=VueInstance(Koohii.UX.KoohiiEditStory,
a,b,!0)},onDialogDestroy:function(){this.editStory&&(this.editStory.$destroy(),this.editStory=null)},isVisible:function(){return this.dialog.isVisible()}}})();
(function(){App.Ui.EditKeywordComponent=Core.make();var c=YAHOO,b=c.util.Dom,a=c.util.Event;App.Ui.EditKeywordComponent.prototype={init:function(a,b,f){this.options=b;this.callback=f;this.dialog=new Core.Ui.AjaxDialog(null,{requestUri:a,requestData:b.params,skin:"rtk-skin-dlg",context:b.context,scope:this,events:{onDialogInit:this.onInit,onDialogDestroy:this.onDestroy,onDialogSuccess:this.onSuccess,onDialogHide:this.onHide}});this.dialog.on("reset",this.onReset,this);this.dialog.show()},show:function(){this.dialog.show();
this.focus()},destroy:function(){this.dialog.destroy();this.dialog=null},focus:function(){var a=this.getInput();a.focus();a.select()},onInit:function(a){this.props=a.getProps();this.evtCache=new Core.Ui.EventCache;this.evtCache.addEvent(this.getInput(),"keydown",Core.bind(this.onKeyDown,this));this.focus()},onDestroy:function(){this.evtCache.destroy();this.evtCache=null},onKeyDown:function(b){return 9===b.keyCode?(this.dialog.getAjaxPanel().post({doNext:!0}),a.stopEvent(b),!1):!0},onHide:function(){return!1},
onSuccess:function(a){a=a.getProps();this.callback(a.keyword,a.next)},onReset:function(a,b){var d=this.getInput();d.value=this.props.orig_keyword;d.focus();return!1},getInput:function(){return b.down(this.dialog.getBody(),"txt-ckw")}}})();
(function(){App.Ui.EditFlashcardDialog=Core.make();var c=YAHOO,b=c.util.Dom;App.Ui.EditFlashcardDialog.prototype={init:function(a,b,d,c){var e=Core.Ui.Mobile.isMobile();this.params=b;this.uri=a;this.options=c;this.dlgOpts={requestUri:a,requestData:b,skin:e?"rtk-mobl-dlg":"rtk-skin-dlg",mobile:e,close:!0,width:270,scope:this,events:{onDialogHide:this.onHide,onDialogResponse:this.onResponse,onDialogSuccess:this.onSuccess}};e||(this.dlgOpts.context=d);this.eventDispatcher=new Core.Ui.EventDispatcher;
if(c.events){a=c.events;for(var f in a)this.eventDispatcher.connect(f,a[f],c.scope)}this.show()},destroy:function(){this.dialog.destroy();this.dialog=null;this.eventDispatcher.destroy()},show:function(){this.dialogRefresh&&(this.dialog.destroy(),this.dialog=null,this.dialogRefresh=!1);this.dialog||(this.dialog=new Core.Ui.AjaxDialog(null,this.dlgOpts),this.dialog.on("JsMenuItem",this.onMenuItem,this));this.dialog.show()},onHide:function(){if(this.reload)return window.location.href=this.reload,!1;
this.eventDispatcher.notify("onMenuHide");return!1},onResponse:function(a){a=a.getProps();a.result&&(this.dialogRefresh=!0,this.eventDispatcher.notify("onMenuResponse",a.result));this.reload=a.reload},onMenuItem:function(a,e){var d=b.getDataset(e),f=this.dialog.getAjaxPanel();if("page"===d.menuid)return window.location.href=d.uri,!1;if("close"===d.menuid||this.eventDispatcher.hasListeners("onMenuItem")&&this.eventDispatcher.notify("onMenuItem",d.menuid))return this.dialog.hide(),!1;d=c.lang.merge(this.params,
{menu:d.menuid});f.post(d,this.dlgOpts.requestUri);return!1}}})();
(function(){App.Ui.DictLookupDialog=Core.make();var c=Core.Ui.Mobile.isMobile();App.Ui.DictLookupDialog.prototype={ucsId:0,vueInst:null,init:function(){this.ucsId=0;var b={skin:c?"rtk-mobl-dlg":"rtk-skin-dlg",mobile:c,scope:this,events:{onDialogDestroy:this.onDialogDestroy,onDialogHide:this.onDialogHide}};c||(b.context=[document.body,"tl","tl",null,[1,1]]);this.dialog=new Core.Ui.AjaxDialog(null,b);this.dialog.show();this.dialog.yPanel.setBody('<div class="JsMount" style="min-height:100px;background:red;"></div>')},load:function(b){if(this.ucsId!==
b){if(!this.vueInst){var a=this.dialog.getBody().querySelector(".JsMount");this.vueInst=VueInstance(Koohii.UX.KoohiiDictList,a,{},!0)}this.vueInst.load(b);this.ucsId=b}},show:function(){this.dialog.show()},hide:function(){this.dialog.hide()},onDialogHide:function(){return!1},onDialogDestroy:function(){},isVisible:function(){return this.dialog.isVisible()}}})();
(function(){var c=YAHOO,b=c.util.Dom;App.KanjiReview={initialize:function(a){this.options=a;a.fcr_options.events={onBeginReview:this.onBeginReview,onEndReview:this.onEndReview,onFlashcardCreate:this.onFlashcardCreate,onFlashcardDestroy:this.onFlashcardDestroy,onFlashcardState:this.onFlashcardState,onFlashcardUndo:this.onFlashcardUndo,onAction:this.onAction,scope:this};this.oReview=new App.Ui.FlashcardReview(a.fcr_options);this.oReview.addShortcutKey("f","flip");this.oReview.addShortcutKey(" ","flip");
this.oReview.addShortcutKey("n","no");this.oReview.addShortcutKey("h","hard");this.oReview.addShortcutKey("y","yes");this.oReview.addShortcutKey("e","easy");this.oReview.addShortcutKey("u","undo");this.oReview.addShortcutKey("s","story");this.oReview.addShortcutKey("d","dict");this.oReview.addShortcutKey("k","skip");this.oReview.addShortcutKey(110,"skip");this.oReview.addShortcutKey("1","no");this.oReview.addShortcutKey("2","yes");this.oReview.addShortcutKey("3","easy");this.oReview.addShortcutKey(96,
"flip");this.oReview.addShortcutKey(97,"no");this.oReview.addShortcutKey(98,"yes");this.oReview.addShortcutKey(99,"easy");this.elFlashcard=b.down(document.body,"uiFcCard","div");this.elStats=b.get("uiFcStats");this.elsCount=b.queryAll("#uiFcProgressBar",".count");this.elProgressBar=b.query("#review-progress","span");this.elAnswerPass=b.down(this.elStats,"JsPass");this.elAnswerFail=b.down(this.elStats,"JsFail");this.countDeleted=this.countNo=this.countYes=0;this.deletedCards=[];this.elFinish=b.down(this.elStats,
"JsFinish")},getOption:function(a){return this.options[a]},onBeginReview:function(){},onEndReview:function(){this.updateStatsPanel();var a=b.get("uiFcRedirectForm");a.method="post";a.action=this.getOption("end_url");a.elements.fc_pass.value=this.countYes;a.elements.fc_fail.value=this.countNo;a.elements.fc_deld.value=this.deletedCards.join(",");a.submit()},onFlashcardCreate:function(){0===this.oReview.getPosition()&&(this.elStats.style.display="block");b.toggle("JsBtnUndo",0<this.oReview.getNumUndos());
this.updateStatsPanel()},onFlashcardDestroy:function(){b.toggle("uiFcButtons0",!1);b.toggle("uiFcButtons1",!1)},onFlashcardUndo:function(a){this.updateAnswerStats(a,!0)},onFlashcardState:function(a){b.toggle("uiFcButtons0",0===a);b.toggle("uiFcButtons1",0!==a)},onAction:function(a,c){var d;d=!1;if("help"===a)return(new Core.Ui.AjaxDialog("JsFcHelpDlg",{useMarkup:!0,context:["JsBtnHelp","tl","bl",null,[0,0]],skin:"rtk-skin-dlg",mobile:!0,close:!1})).show(),!1;if(!this.oReview.getFlashcard())return!1;
if("story"===a)return this.editStoryDialog&&this.editStoryDialog.isVisible()?this.editStoryDialog.hide():(d=this.oReview.getFlashcardData(),this.editStoryDialog?(this.editStoryDialog.load(d.id),this.editStoryDialog.show()):this.editStoryDialog=new App.Ui.EditStoryDialog(this.getOption("editstory_url"),d.id)),!1;if("dict"===a)return this.toggleDictDialog(),!1;switch(a){case "fcmenu":this.flashcardMenu();break;case "delete":this.answerCard(4);break;case "flip":if("click"===c.type&&b.hasClass(c.target,
"JsKeywordLink"))return!0;0===this.oReview.getFlashcardState()&&this.oReview.setFlashcardState(1);break;case "undo":0<this.oReview.getNumUndos()&&this.oReview.backward();break;case "end":this.elFinish.style.display="none";this.oReview.endReview();break;case "skip":this.answerCard(5);break;case "no":d=1;break;case "hard":d="h";break;case "yes":d=2;break;case "easy":d=3}d&&0<this.oReview.getFlashcardState()&&this.answerCard(d);return!1},toggleDictDialog:function(){if(this.dictDialog&&this.dictDialog.isVisible())this.dictDialog.hide();
else{var a=this.oReview.getFlashcardData().id;this.dictDialog||(this.dictDialog=new App.Ui.DictLookupDialog);this.dictDialog.show();this.dictDialog.load(a)}},answerCard:function(a){a={id:this.oReview.getFlashcardData().id,r:a};this.oReview.answerCard(a);this.updateAnswerStats(a,!1);this.oReview.forward()},skipFlashcard:function(){this.answerCard(5)},flashcardMenu:function(){function a(){b.removeClass(d,"active")}function e(a){return"confirm-delete"===a?(this.answerCard(4),!0):"skip"===a?(this.skipFlashcard(),
!0):!1}var d=b.get("uiFcMenu"),f=b.getDataset(d),g=this.oReview.getFlashcardData();b.addClass(d,"active");g.id!==this.oEditFlashcardId&&(this.oEditFlashcardId=g.id,this.oEditFlashcard&&(this.oEditFlashcard.destroy(),this.oEditFlashcard=null));this.oEditFlashcard?this.oEditFlashcard.show():(g=c.lang.merge(c.lang.JSON.parse(f.param),{ucs:g.id}),this.oEditFlashcard=new App.Ui.EditFlashcardDialog(f.uri,g,[d,"tr","br"],{events:{onMenuHide:a,onMenuItem:e},scope:this}));return!1},updateStatsPanel:function(){var a=
this.oReview.getItems().length,b=this.oReview.getPosition();this.elsCount[0].innerHTML=Math.min(b+1,a);this.elsCount[1].innerHTML=a;a=0<b?Math.ceil(100*b/a):0;a=Math.min(a,100);this.elProgressBar.style.width=(0<a?a:0)+"%"},updateAnswerStats:function(a,b){var d=2===a.r||3===a.r?1:0,c=1===a.r||"h"===a.r?1:0,e=4===a.r?1:0;b&&(d=-d,c=-c,e=-e);this.countYes+=d;this.countNo+=c;this.elAnswerPass.innerHTML=this.countYes;this.elAnswerFail.innerHTML=this.countNo;0!==e&&this.updateDeletedCards(a.id,e)},updateDeletedCards:function(a,
c){this.countDeleted+=c;0<c?this.deletedCards.push(a):0>c&&this.deletedCards.pop();b.toggle("uiFcStDeld",0<this.countDeleted);b.get("uiFcStDeld").getElementsByTagName("em")[0].innerHTML=this.countDeleted;b.getFirstChild("uiFcStDeldK").innerHTML=this.getDeletedCards()},getDeletedCards:function(){return"&#"+this.deletedCards.join(";&#")+";"},setButtonState:function(a,c){var d,e;d=b.getElementsByClassName("uiIBtn","a",a);for(e=0;e<d.length;e++)b.setClass(d[e],"uiFcBtnDisabled",c)}};window.rkKanjiReview=
App.KanjiReview})();
